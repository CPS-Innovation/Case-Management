{
	"info": {
		"_postman_id": "528fe339-2fbc-4135-bb3d-8db19a6412c8",
		"name": "Case Registration API Tests",
		"description": "Comprehensive test suite for \\`POST /v1/cases\\` endpoint including happy paths and validator-driven negative test cases. All 200 OK responses enforce \\`caseId > 0\\` to catch silent validation failures.\n\n## Overview\n\nThis collection tests the Case Registration API with:  \n\\- ✅ Happy path scenarios (non-suspect and with suspects)  \n\\- ✅ Negative test cases (invalid URN, future dates, empty monitoring codes)  \n\\- ✅ Automatic validation that successful responses return \\`caseId > 0\\`  \n\\- ✅ Authentication via Azure AD and CMS cookies\n\n## Authentication\n\n### Azure AD Token (Collection Level)\n\nThe collection-level pre-request script automatically retrieves an Azure AD access token using the OAuth 2.0 client credentials flow (v2.0 endpoint).\n\n**How it works:**  \n\\- Tokens are fetched using collection variables: \\`tenantId\\`, \\`clientId\\`, \\`clientSecret\\`, \\`scope\\`  \n\\- Token is cached in \\`accessToken\\` and \\`accessTokenExpiry\\` collection variables  \n\\- Auto-refreshes 60 seconds before expiry  \n\\- Authorization header set at collection level: \\`Bearer {{accessToken}}\\`\n\n### CMS Authentication Cookie\n\nThe **Cms-Auth-Values** cookie is set via pre-request script:  \n\\- Calls the environment-specific MDS \\`/authenticate\\` endpoint  \n\\- Uses \\`mdsBaseUrl\\`, \\`cmsUsername\\`, \\`cmsPassword\\` variables  \n\\- Retrieves and sets the authentication cookie value automatically\n\n## Setup Instructions\n\n1\\. Import Collection and Environment\n\nImport the following files into Postman:  \n\\- \\`Case Registration API Tests.postman_collection.json\\`  \n\\- Your environment file (Local, Dev, etc.)\n\n2\\. Configure Collection Variables\n\nEnsure these collection variables are populated:\n\n| Variable | Description | Notes |\n| --- | --- | --- |\n| urnUniqueRef | 5-digit unique reference number | Autogenerated in Pre-Script |\n| accessTokenExpiry | Token expiry timestamp (auto-managed) | Autogenerated in Pre-Script |\n| mdsBaseUrl | MDS API base URL |  |\n| mdsAccessKey | MDS API access key |  |\n| cmsUsername | CMS authentication username |  |\n| cmsPassword | CMS authentication password |  |\n| cmsAuth | CMS auth cookie value (auto-managed) | Autogenerated in Pre-Script |\n| baseUrl | Case Management API URL |  |\n| clientId | Azure AD application (client) ID |  |\n| clientSecret | Azure AD application (client) secret |  |\n| tenantId | Azure AD application (tenant) ID |  |\n| scope | Azure AD application (scope) | api:///.default |\n\n## Test Requests\n\nThe collection includes 5 test requests:\n\n1\\. Non-Suspect Case (200 OK) Creates a case without suspects. Validates:  \n\\- Status code is 200  \n\\- \\`caseId\\` is an integer > 0 (fails if \\`caseId = 0\\`)  \n\\- \\`urn\\` matches format.\n\n2\\. Case With Suspects (200 OK) Creates a case including suspect information. Same validations as above.\n\n3\\. Invalid URN - 400 Sends invalid police force code (e.g., \\`450\\`). Expects:  \n\\- Status code 400  \n\\- Validation error message (JSON or text)\n\n4\\. Future dateFrom - 400 Sends a \\`dateFrom\\` set to tomorrow. Expects:  \n\\- Status code 400  \n\\- Validation error indicating future dates not allowed\n\n5\\. Empty Monitoring Codes - 400 Sends empty \\`monitoringCodes\\` array. Expects:  \n\\- Status code 400  \n\\- Validation error for required monitoring codes\n\n## Pre-Request Script\n\nThe collection pre-request script automatically generates:  \n\\- \\`correlationId\\` - A new GUID for each request  \n\\- \\`today\\` - Current date in ISO format  \n\\- \\`tomorrow\\` - Tomorrow's date in ISO format  \n\\- \\`urnUniqueRef\\` - A random 5-digit number (unless overridden)\n\n**Overriding urnUniqueRef**\n\nTo use a specific URN reference number:  \n1\\. Set \\`urnUniqueRef\\` in your collection or environment variables  \n2\\. The pre-request script will use your value instead of generating a random one\n\n## Running Tests\n\nRun Entire Collection\n\n1\\. Click the 3 dots near the collection name  \n2\\. Click \"Run\" to open Collection Runner  \n3\\. Select your environment  \n4\\. Click \"Run Case Registration\"\n\nRun Individual Requests\n\n1\\. Select a request  \n2\\. Ensure environment is selected  \n3\\. Click \"Send\"  \n4\\. Review test results in the \"Test Results\" tab\n\n**Why caseId = 0 is a Failure**\n\nThe API should never return \\`caseId = 0\\` on a successful response. This would indicate:  \n\\- A non-unique URN was submitted  \n\\- Silent validation failure in the backend  \n\\- Database insertion issues\n\n**All 200 OK responses enforce this check to catch these issues immediately.**\n\n## Troubleshooting\n\nAuthentication Failures\n\n\\- Verify \\`tenantId\\`, \\`clientId\\`, \\`clientSecret\\`, and \\`scope\\` are correct  \n\\- Check Azure AD app registration has appropriate API permissions  \n\\- Ensure MDS credentials (\\`cmsUsername\\`, \\`cmsPassword\\`) are valid\n\nToken Not Refreshing\n\n\\- The token auto-refreshes 60s before expiry  \n\\- If issues persist, manually delete \\`accessToken\\` and \\`accessTokenExpiry\\` variables to force a new token\n\nCookie Issues\n\n\\- Verify \\`mdsBaseUrl\\` points to the correct environment  \n\\- Check MDS \\`/authenticate\\` endpoint is accessible  \n\\- Ensure \\`mdsAccessKey\\` is valid\n\nTest Failures\n\n\\- Review the \"Test Results\" tab for specific assertion failures  \n\\- Check the response body for validation errors  \n\\- Verify request payload matches expected schema  \n\\- Ensure \\`urnUniqueRef\\` is truly unique (increment it between runs)\n\n## Test Coverage Summary\n\n| Scenario | Expected Result | Key Validations |\n| --- | --- | --- |\n| Non-suspect case | 200 OK | \\`caseId > 0\\`, URN format |\n| Case with suspects | 200 OK | \\`caseId > 0\\`, URN format |\n| Invalid URN | 400 Bad Request | Validation error present |\n| Future dateFrom | 400 Bad Request | Date validation error |\n| Empty monitoring codes | 400 Bad Request | Required field error |\n|  |  |  |",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "33521176"
	},
	"item": [
		{
			"name": "1. Non-suspect Journey (200)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Test for 200 OK response",
							"pm.test('Status code is 200 OK', function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"// Parse response body",
							"let responseBody;",
							"try {",
							"    responseBody = pm.response.json();",
							"} catch (e) {",
							"    pm.test('Response is valid JSON', function () {",
							"        throw new Error('Failed to parse response as JSON');",
							"    });",
							"    return;",
							"}",
							"",
							"// CRITICAL: Assert caseId > 0",
							"pm.test('❗ caseId is greater than 0 (not zero)', function () {",
							"    pm.expect(responseBody).to.have.property('caseId');",
							"    pm.expect(responseBody.caseId).to.be.a('number');",
							"    pm.expect(responseBody.caseId).to.be.above(0);",
							"});",
							"",
							"// Validate caseId is an integer",
							"pm.test('caseId is an integer', function () {",
							"    pm.expect(Number.isInteger(responseBody.caseId)).to.be.true;",
							"});",
							"",
							"// Validate URN format",
							"pm.test('urn matches expected format (DDXXNNNNNYY)', function () {",
							"    pm.expect(responseBody).to.have.property('urn');",
							"    pm.expect(responseBody.urn).to.be.a('string');",
							"    const urnPattern = /^\\d{2}[A-Z0-9]{2}\\d{7}$/;",
							"    pm.expect(responseBody.urn).to.match(urnPattern);",
							"});",
							"",
							"console.log('Response:', JSON.stringify(responseBody, null, 2));"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Correlation-Id",
						"value": "{{correlationId}}"
					},
					{
						"key": "Cookie",
						"value": "Cms-Auth-Values={{cmsAuth}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"urn\": {\n        \"policeForce\": \"45\",\n        \"policeUnit\": \"EL\",\n        \"uniqueRef\": \"{{urnUniqueRef}}\",\n        \"year\": 25\n    },\n    \"registeringAreaId\": 1001,\n    \"registeringUnitId\": 2002,\n    \"allocatedWcuId\": 2012391,\n    \"crest\": \"\",\n    \"operationName\": \"\",\n    \"courtLocationId\": 0,\n    \"courtLocationName\": \"\",\n    \"hearingDate\": null,\n    \"defendants\": [],\n    \"victims\": [],\n    \"complexity\": \"\",\n    \"caseWeight\": \"\",\n    \"monitoringCodes\":[\n        {\n            \"code\": \"ATRY\",\n            \"selected\": true\n        }\n    ],\n    \"prosecutorId\": 0,\n    \"caseWorker\": \"\",\n    \"oicRank\": \"\",\n    \"oicSurname\": \"\",\n    \"oicFirstnames\": \"\",\n    \"oicShoulderNumber\": \"\",\n    \"oicPoliceUnit\": \"\"\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/v1/cases",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"v1",
						"cases"
					]
				},
				"description": "Happy path test for creating a case without defendants."
			},
			"response": []
		},
		{
			"name": "2. With Defendants Journey (200)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test('Status code is 200 OK', function () { pm.response.to.have.status(200); });",
							"let responseBody = pm.response.json();",
							"pm.test('caseId > 0', () => pm.expect(responseBody.caseId).to.be.above(0));",
							"pm.test('caseId integer', () => pm.expect(Number.isInteger(responseBody.caseId)).to.be.true);",
							"const urnPattern = /^\\d{2}[A-Z0-9]{2}\\d{7}$/;",
							"pm.test('URN format valid', () => pm.expect(responseBody.urn).to.match(urnPattern));",
							"console.log('Response:', JSON.stringify(responseBody, null, 2));"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Correlation-Id",
						"value": "{{correlationId}}"
					},
					{
						"key": "Cookie",
						"value": "Cms-Auth-Values={{cmsAuth}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"urn\": {\r\n        \"policeForce\": \"45\",\r\n        \"policeUnit\": \"EL\",\r\n        \"uniqueRef\": \"{{urnUniqueRef}}\",\r\n        \"year\": 25\r\n    },\r\n    \"registeringAreaId\": 1001,\r\n    \"registeringUnitId\": 2002,\r\n    \"allocatedWcuId\": 2012391,\r\n    \"crest\": \"\",\r\n    \"operationName\": \"\",\r\n    \"courtLocationId\": 0,\r\n    \"courtLocationName\": \"\",\r\n    \"hearingDate\": null,\r\n    \"defendants\": [\r\n        {\r\n            \"isDefendant\": true,\r\n            \"surname\": \"Miller\",\r\n            \"firstname\": \"Willie\",\r\n            \"companyName\": \"\",\r\n            \"dateOfBirth\": \"1984-05-23\",\r\n            \"gender\": \"M\",\r\n            \"disability\": \"U\",\r\n            \"ethnicity\": \"W1\",\r\n            \"religion\": \"NP\",\r\n            \"type\": \"UN\",\r\n            \"arrestDate\": null,\r\n            \"seriousDangerousOffender\": false,\r\n            \"arrestSummonsNumber\": \"\",\r\n            \"isNotYetCharged\": false,\r\n            \"aliases\": [\r\n                {\r\n                    \"listOrder\": 0,\r\n                    \"surname\": \"McCoy\",\r\n                    \"firstNames\": \"William Archibald\"\r\n                }\r\n            ],\r\n            \"charges\": [\r\n                {\r\n                    \"offenceCode\": \"FI68036\",\r\n                    \"offenceDescription\": \"Possess a prohibited weapon ( automatic )\",\r\n                    \"offenceId\": \"22336\",\r\n                    \"dateFrom\": \"2025-10-01\",\r\n                    \"dateTo\": null,\r\n                    \"comment\": \"\",\r\n                    \"offenceLocation\": {\r\n                        \"addressLine1\": \"\",\r\n                        \"addressLine2\": \"\",\r\n                        \"townCity\": \"\",\r\n                        \"postcode\": \"\"\r\n                    },\r\n                    \"victimIndexId\": 0,\r\n                    \"chargeDetailsSummary\": \"\",\r\n                    \"modeOfTrial\": \"EW\"\r\n                }\r\n            ]\r\n        },\r\n        {\r\n            \"isDefendant\": true,\r\n            \"surname\": \"McGinty\",\r\n            \"firstname\": \"Bunty\",\r\n            \"companyName\": \"\",\r\n            \"dateOfBirth\": \"1969-10-14\",\r\n            \"gender\": \"F\",\r\n            \"disability\": \"U\",\r\n            \"ethnicity\": \"W1\",\r\n            \"religion\": \"NP\",\r\n            \"type\": \"UN\",\r\n            \"arrestDate\": null,\r\n            \"seriousDangerousOffender\": true,\r\n            \"arrestSummonsNumber\": \"ASN1234\",\r\n            \"isNotYetCharged\": false,\r\n            \"aliases\": [],\r\n            \"charges\": [\r\n                {\r\n                    \"offenceCode\": \"FI68036\",\r\n                    \"offenceDescription\": \"Possess a prohibited weapon ( automatic )\",\r\n                    \"offenceId\": \"22336\",\r\n                    \"dateFrom\": \"2025-10-01\",\r\n                    \"dateTo\": null,\r\n                    \"comment\": \"\",\r\n                    \"offenceLocation\": {\r\n                        \"addressLine1\": \"\",\r\n                        \"addressLine2\": \"\",\r\n                        \"townCity\": \"\",\r\n                        \"postcode\": \"\"\r\n                    },\r\n                    \"victimIndexId\": 0,\r\n                    \"chargeDetailsSummary\": \"\",\r\n                    \"modeOfTrial\": \"EW\"\r\n                },\r\n                {\r\n                    \"offenceCode\": \"AL79014\",\r\n                    \"offenceDescription\": \"Sold controlled liquor wholesale to a buyer who will sell or supply it through a trade or business\",\r\n                    \"offenceId\": \"38808\",\r\n                    \"dateFrom\": \"2025-10-01\",\r\n                    \"dateTo\": null,\r\n                    \"comment\": \"\",\r\n                    \"offenceLocation\": {\r\n                        \"addressLine1\": \"\",\r\n                        \"addressLine2\": \"\",\r\n                        \"townCity\": \"\",\r\n                        \"postcode\": \"\"\r\n                    },\r\n                    \"victimIndexId\": 1,\r\n                    \"chargeDetailsSummary\": \"\",\r\n                    \"modeOfTrial\": \"EW\"\r\n                }\r\n            ]\r\n        }\r\n    ],\r\n    \"victims\": [\r\n        {\r\n            \"surname\": \"Jamieson\",\r\n            \"forename\": \"Bongo\",\r\n            \"isVulnerable\": false,\r\n            \"isIntimidated\": false,\r\n            \"isWitness\": false\r\n        },\r\n        {\r\n            \"surname\": \"McDonald\",\r\n            \"forename\": \"Ronaldo\",\r\n            \"isVulnerable\": false,\r\n            \"isIntimidated\": true,\r\n            \"isWitness\": false\r\n        }\r\n    ],\r\n    \"complexity\": \"\",\r\n    \"caseWeight\": \"\",\r\n    \"monitoringCodes\":[\r\n        {\r\n            \"code\": \"ATRY\",\r\n            \"selected\": true\r\n        }\r\n    ],\r\n    \"prosecutorId\": 0,\r\n    \"caseWorker\": \"\",\r\n    \"oicRank\": \"\",\r\n    \"oicSurname\": \"\",\r\n    \"oicFirstnames\": \"\",\r\n    \"oicShoulderNumber\": \"\",\r\n    \"oicPoliceUnit\": \"\"\r\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/v1/cases",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"v1",
						"cases"
					]
				},
				"description": "Happy path test for creating a case with multiple defendants."
			},
			"response": []
		},
		{
			"name": "3. Invalid URN - policeForce 450 (400)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Test for 400 Bad Request response\r",
							"pm.test('Status code is 400 Bad Request', function () {\r",
							"    pm.response.to.have.status(400);\r",
							"});\r",
							"\r",
							"pm.test('Error message contains expected text', function () {\r",
							"    const responseBody = pm.response.json();\r",
							"    pm.expect(responseBody).to.be.an('array');\r",
							"    pm.expect(responseBody[0]).to.include(\"PoliceForce must be exactly 2 digits (00-99)\");\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Correlation-Id",
						"value": "{{correlationId}}"
					},
					{
						"key": "Cookie",
						"value": "Cms-Auth-Values={{cmsAuth}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"urn\": {\r\n        \"policeForce\": \"450\",\r\n        \"policeUnit\": \"EL\",\r\n        \"uniqueRef\": \"{{urnUniqueRef}}\",\r\n        \"year\": 25\r\n    },\r\n    \"registeringAreaId\": 1001,\r\n    \"registeringUnitId\": 2002,\r\n    \"allocatedWcuId\": 2012391,\r\n    \"crest\": \"\",\r\n    \"operationName\": \"\",\r\n    \"courtLocationId\": 0,\r\n    \"courtLocationName\": \"\",\r\n    \"hearingDate\": null,\r\n    \"defendants\": [],\r\n    \"victims\": [],\r\n    \"complexity\": \"\",\r\n    \"caseWeight\": \"\",\r\n    \"monitoringCodes\":[\r\n        {\r\n            \"code\": \"ATRY\",\r\n            \"selected\": true\r\n        }\r\n    ],\r\n    \"prosecutorId\": 0,\r\n    \"caseWorker\": \"\",\r\n    \"oicRank\": \"\",\r\n    \"oicSurname\": \"\",\r\n    \"oicFirstnames\": \"\",\r\n    \"oicShoulderNumber\": \"\",\r\n    \"oicPoliceUnit\": \"\"\r\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/v1/cases",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"v1",
						"cases"
					]
				},
				"description": "Negative test: invalid police force."
			},
			"response": []
		},
		{
			"name": "4. Future dateFrom in Charge (400)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Test for 400 Bad Request response\r",
							"pm.test('Status code is 400 Bad Request', function () {\r",
							"    pm.response.to.have.status(400);\r",
							"});\r",
							"\r",
							"pm.test('Error message contains expected text', function () {\r",
							"    const responseBody = pm.response.json();\r",
							"    pm.expect(responseBody).to.be.an('array');\r",
							"    pm.expect(responseBody[0]).to.include(\"'Date From' must be less than or equal to\");\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Correlation-Id",
						"value": "{{correlationId}}"
					},
					{
						"key": "Cookie",
						"value": "Cms-Auth-Values={{cmsAuth}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"urn\": {\r\n        \"policeForce\": \"45\",\r\n        \"policeUnit\": \"EL\",\r\n        \"uniqueRef\": \"{{urnUniqueRef}}\",\r\n        \"year\": 25\r\n    },\r\n    \"registeringAreaId\": 1001,\r\n    \"registeringUnitId\": 2002,\r\n    \"allocatedWcuId\": 2012391,\r\n    \"crest\": \"\",\r\n    \"operationName\": \"\",\r\n    \"courtLocationId\": 0,\r\n    \"courtLocationName\": \"\",\r\n    \"hearingDate\": null,\r\n    \"defendants\": [\r\n        {\r\n            \"isDefendant\": true,\r\n            \"surname\": \"Miller\",\r\n            \"firstname\": \"Willie\",\r\n            \"companyName\": \"\",\r\n            \"dateOfBirth\": \"1984-05-23\",\r\n            \"gender\": \"M\",\r\n            \"disability\": \"U\",\r\n            \"ethnicity\": \"W1\",\r\n            \"religion\": \"NP\",\r\n            \"type\": \"UN\",\r\n            \"arrestDate\": null,\r\n            \"seriousDangerousOffender\": false,\r\n            \"arrestSummonsNumber\": \"\",\r\n            \"isNotYetCharged\": false,\r\n            \"aliases\": [\r\n                {\r\n                    \"listOrder\": 0,\r\n                    \"surname\": \"McCoy\",\r\n                    \"firstNames\": \"William Archibald\"\r\n                }\r\n            ],\r\n            \"charges\": [\r\n                {\r\n                    \"offenceCode\": \"FI68036\",\r\n                    \"offenceDescription\": \"Possess a prohibited weapon ( automatic )\",\r\n                    \"offenceId\": \"22336\",\r\n                    \"dateFrom\": \"2025-10-01\",\r\n                    \"dateTo\": null,\r\n                    \"comment\": \"\",\r\n                    \"offenceLocation\": {\r\n                        \"addressLine1\": \"\",\r\n                        \"addressLine2\": \"\",\r\n                        \"townCity\": \"\",\r\n                        \"postcode\": \"\"\r\n                    },\r\n                    \"victimIndexId\": 0,\r\n                    \"chargeDetailsSummary\": \"\",\r\n                    \"modeOfTrial\": \"EW\"\r\n                }\r\n            ]\r\n        },\r\n        {\r\n            \"isDefendant\": true,\r\n            \"surname\": \"McGinty\",\r\n            \"firstname\": \"Bunty\",\r\n            \"companyName\": \"\",\r\n            \"dateOfBirth\": \"1969-10-14\",\r\n            \"gender\": \"F\",\r\n            \"disability\": \"U\",\r\n            \"ethnicity\": \"W1\",\r\n            \"religion\": \"NP\",\r\n            \"type\": \"UN\",\r\n            \"arrestDate\": null,\r\n            \"seriousDangerousOffender\": true,\r\n            \"arrestSummonsNumber\": \"ASN1234\",\r\n            \"isNotYetCharged\": false,\r\n            \"aliases\": [],\r\n            \"charges\": [\r\n                {\r\n                    \"offenceCode\": \"FI68036\",\r\n                    \"offenceDescription\": \"Possess a prohibited weapon ( automatic )\",\r\n                    \"offenceId\": \"22336\",\r\n                    \"dateFrom\": \"{{tomorrow}}\",\r\n                    \"dateTo\": null,\r\n                    \"comment\": \"\",\r\n                    \"offenceLocation\": {\r\n                        \"addressLine1\": \"\",\r\n                        \"addressLine2\": \"\",\r\n                        \"townCity\": \"\",\r\n                        \"postcode\": \"\"\r\n                    },\r\n                    \"victimIndexId\": 0,\r\n                    \"chargeDetailsSummary\": \"\",\r\n                    \"modeOfTrial\": \"EW\"\r\n                },\r\n                {\r\n                    \"offenceCode\": \"AL79014\",\r\n                    \"offenceDescription\": \"Sold controlled liquor wholesale to a buyer who will sell or supply it through a trade or business\",\r\n                    \"offenceId\": \"38808\",\r\n                    \"dateFrom\": \"2025-10-01\",\r\n                    \"dateTo\": null,\r\n                    \"comment\": \"\",\r\n                    \"offenceLocation\": {\r\n                        \"addressLine1\": \"\",\r\n                        \"addressLine2\": \"\",\r\n                        \"townCity\": \"\",\r\n                        \"postcode\": \"\"\r\n                    },\r\n                    \"victimIndexId\": 1,\r\n                    \"chargeDetailsSummary\": \"\",\r\n                    \"modeOfTrial\": \"EW\"\r\n                }\r\n            ]\r\n        }\r\n    ],\r\n    \"victims\": [\r\n        {\r\n            \"surname\": \"Jamieson\",\r\n            \"forename\": \"Bongo\",\r\n            \"isVulnerable\": false,\r\n            \"isIntimidated\": false,\r\n            \"isWitness\": false\r\n        },\r\n        {\r\n            \"surname\": \"McDonald\",\r\n            \"forename\": \"Ronaldo\",\r\n            \"isVulnerable\": false,\r\n            \"isIntimidated\": true,\r\n            \"isWitness\": false\r\n        }\r\n    ],\r\n    \"complexity\": \"\",\r\n    \"caseWeight\": \"\",\r\n    \"monitoringCodes\":[\r\n        {\r\n            \"code\": \"ATRY\",\r\n            \"selected\": true\r\n        }\r\n    ],\r\n    \"prosecutorId\": 0,\r\n    \"caseWorker\": \"\",\r\n    \"oicRank\": \"\",\r\n    \"oicSurname\": \"\",\r\n    \"oicFirstnames\": \"\",\r\n    \"oicShoulderNumber\": \"\",\r\n    \"oicPoliceUnit\": \"\"\r\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/v1/cases",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"v1",
						"cases"
					]
				}
			},
			"response": []
		},
		{
			"name": "5. Empty monitoringCodes (400)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Test for 400 Bad Request response\r",
							"pm.test('Status code is 400 Bad Request', function () {\r",
							"    pm.response.to.have.status(400);\r",
							"});\r",
							"\r",
							"pm.test('Error message contains expected text', function () {\r",
							"    const responseBody = pm.response.json();\r",
							"    pm.expect(responseBody).to.be.an('array');\r",
							"    pm.expect(responseBody[0]).to.include(\"'Monitoring Codes' must not be empty.\");\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Correlation-Id",
						"value": "{{correlationId}}"
					},
					{
						"key": "Cookie",
						"value": "Cms-Auth-Values={{cmsAuth}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"urn\": {\r\n        \"policeForce\": \"45\",\r\n        \"policeUnit\": \"EL\",\r\n        \"uniqueRef\": \"{{urnUniqueRef}}\",\r\n        \"year\": 25\r\n    },\r\n    \"registeringAreaId\": 1001,\r\n    \"registeringUnitId\": 2002,\r\n    \"allocatedWcuId\": 2012391,\r\n    \"crest\": \"\",\r\n    \"operationName\": \"\",\r\n    \"courtLocationId\": 0,\r\n    \"courtLocationName\": \"\",\r\n    \"hearingDate\": null,\r\n    \"defendants\": [],\r\n    \"victims\": [],\r\n    \"complexity\": \"\",\r\n    \"caseWeight\": \"\",\r\n    \"monitoringCodes\":[],\r\n    \"prosecutorId\": 0,\r\n    \"caseWorker\": \"\",\r\n    \"oicRank\": \"\",\r\n    \"oicSurname\": \"\",\r\n    \"oicFirstnames\": \"\",\r\n    \"oicShoulderNumber\": \"\",\r\n    \"oicPoliceUnit\": \"\"\r\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/api/v1/cases",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"api",
						"v1",
						"cases"
					]
				}
			},
			"response": []
		}
	],
	"auth": {
		"type": "bearer",
		"bearer": [
			{
				"key": "token",
				"value": "{{accessToken}}",
				"type": "string"
			}
		]
	},
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"requests": {},
				"exec": [
					"/**",
					" * Collection-level Pre-Request Script",
					" * ",
					" * This script performs three main tasks:",
					" * 1. Azure AD Token Management - Obtains and caches OAuth tokens",
					" * 2. CMS Authentication - Sets up authentication cookies for CMS API calls",
					" * 3. Variable Setup - Generates common request variables (dates, IDs, etc.)",
					" */",
					"",
					"(function () {",
					"  const col = pm.collectionVariables;",
					"  const errors = [];",
					"  const warnings = [];",
					"",
					"  // ============================================",
					"  // PART 1: Azure AD Token Management",
					"  // ============================================",
					"  console.log('\\n=== Azure AD Token Management ===');",
					"  ",
					"  const tenantId = col.get('tenantId');",
					"  const clientId = col.get('clientId');",
					"  const clientSecret = col.get('clientSecret');",
					"  const scope = col.get('scope');",
					"",
					"  // Check for required AAD variables",
					"  const missingAadVars = [];",
					"  if (!tenantId) missingAadVars.push('tenantId');",
					"  if (!clientId) missingAadVars.push('clientId');",
					"  if (!clientSecret) missingAadVars.push('clientSecret');",
					"  if (!scope) missingAadVars.push('scope');",
					"",
					"  if (scope && !scope.endsWith('/.default')) {",
					"    warnings.push(\"[AAD] scope should be '<resource>/.default' for client_credentials\");",
					"  }",
					"",
					"",
					"  if (missingAadVars.length > 0) {",
					"    const msg = `[AAD] ❌ Missing required variables: ${missingAadVars.join(', ')}`;",
					"    console.error(msg);",
					"    warnings.push(msg);",
					"  } else {",
					"    const now = Date.now();",
					"",
					"      console.log('[AAD] → Requesting new access token...');",
					"      const tokenUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/token`;",
					"",
					"      pm.sendRequest({",
					"        url: tokenUrl,",
					"        method: 'POST',",
					"        header: {",
					"          'Content-Type': 'application/x-www-form-urlencoded'",
					"        },",
					"        body: {",
					"          mode: 'urlencoded',",
					"          urlencoded: [",
					"            { key: 'client_id', value: clientId },",
					"            { key: 'client_secret', value: clientSecret },",
					"            { key: 'scope', value: scope },",
					"            { key: 'grant_type', value: 'client_credentials' }",
					"          ]",
					"        }",
					"      }, function (err, res) {",
					"        if (err) {",
					"          const msg = `[AAD] ❌ Token request failed: ${err.message || err}`;",
					"          console.error(msg);",
					"          errors.push(msg);",
					"          return;",
					"        }",
					"",
					"        if (!res) {",
					"          const msg = '[AAD] ❌ No response received from token endpoint';",
					"          console.error(msg);",
					"          errors.push(msg);",
					"          return;",
					"        }",
					"",
					"        let json;",
					"        try {",
					"          json = res.json();",
					"        } catch (e) {",
					"          const msg = `[AAD] ❌ Failed to parse token response: ${e.message}`;",
					"          console.error(msg);",
					"          errors.push(msg);",
					"          return;",
					"        }",
					"",
					"        // Check for error in response",
					"        if (json.error) {",
					"          const msg = `[AAD] ❌ Token request error: ${json.error}${json.error_description ? ' - ' + json.error_description : ''}`;",
					"          console.error(msg);",
					"          errors.push(msg);",
					"          return;",
					"        }",
					"",
					"        const accessToken = json.access_token || json.accessToken;",
					"        const expiresIn = Number(json.expires_in);",
					"",
					"        if (!accessToken) {",
					"          const msg = '[AAD] ❌ Token response missing access_token';",
					"          console.error(msg);",
					"          errors.push(msg);",
					"          return;",
					"        }",
					"",
					"        if (!expiresIn || expiresIn <= 0) {",
					"          const msg = '[AAD] ❌ Token response missing or invalid expires_in';",
					"          console.error(msg);",
					"          errors.push(msg);",
					"          return;",
					"        }",
					"",
					"        col.set('accessToken', accessToken);",
					"        col.set('accessTokenExpiry', String(now + (expiresIn * 1000)));",
					"        console.log(`[AAD] ✓ New token obtained (expires in ${expiresIn}s)`);",
					"      });",
					"  }",
					"",
					"  // ============================================",
					"  // PART 2: CMS Authentication Cookie",
					"  // ============================================",
					"  console.log('\\n=== CMS Authentication ===');",
					"  ",
					"  const cmsUsername = col.get('cmsUsername');",
					"  const cmsPassword = col.get('cmsPassword');",
					"  const cmsAccessKey = col.get('mdsAccessKey');",
					"  const mdsBaseUrl = pm.variables.replaceIn('{{mdsBaseUrl}}');",
					"",
					"  // Check if all CMS variables are present",
					"  const missingCmsVars = [];",
					"  if (!mdsBaseUrl || mdsBaseUrl === '{{mdsBaseUrl}}') missingCmsVars.push('mdsBaseUrl');",
					"  if (!cmsUsername) missingCmsVars.push('cmsUsername');",
					"  if (!cmsPassword) missingCmsVars.push('cmsPassword');",
					"  if (!cmsAccessKey) missingCmsVars.push('mdsAccessKey');",
					"",
					"  if (missingCmsVars.length > 0) {",
					"    console.log(`[CMS] ℹ Skipping (missing: ${missingCmsVars.join(', ')})`);",
					"  } else {",
					"    console.log('[CMS] → Authenticating...');",
					"    const authUrl = `${mdsBaseUrl}/api/authenticate`;",
					"",
					"    pm.sendRequest({",
					"      url: authUrl,",
					"      method: 'POST',",
					"      header: {",
					"        'Content-Type': 'application/x-www-form-urlencoded',",
					"        'x-functions-key': cmsAccessKey",
					"      },",
					"      body: {",
					"        mode: 'urlencoded',",
					"        urlencoded: [",
					"          { key: 'username', value: cmsUsername },",
					"          { key: 'password', value: cmsPassword }",
					"        ]",
					"      }",
					"    }, function (err, res) {",
					"      if (err) {",
					"        const msg = `[CMS] ❌ Auth request failed: ${err.message || err}`;",
					"        console.error(msg);",
					"        errors.push(msg);",
					"        return;",
					"      }",
					"",
					"      if (!res) {",
					"        const msg = '[CMS] ❌ No response received from auth endpoint';",
					"        console.error(msg);",
					"        errors.push(msg);",
					"        return;",
					"      }",
					"",
					"      if (res.code >= 400) {",
					"        const msg = `[CMS] ❌ Auth failed with status ${res.code}: ${res.status}`;",
					"        console.error(msg);",
					"        errors.push(msg);",
					"        return;",
					"      }",
					"",
					"      let json;",
					"      try {",
					"        json = res.json();",
					"      } catch (e) {",
					"        const msg = `[CMS] ❌ Failed to parse auth response: ${e.message}`;",
					"        console.error(msg);",
					"        errors.push(msg);",
					"        return;",
					"      }",
					"",
					"      if (!json || typeof json !== 'object') {",
					"        const msg = '[CMS] ❌ Invalid auth response structure';",
					"        console.error(msg);",
					"        errors.push(msg);",
					"        return;",
					"      }",
					"",
					"      // URL-encode the compact JSON response",
					"      const compactJson = JSON.stringify(json);",
					"      const encoded = encodeURIComponent(compactJson);",
					"      ",
					"      col.set('cmsAuth', encoded);",
					"      console.log('[CMS] ✓ Authentication successful, cookie set');",
					"    });",
					"  }",
					"",
					"  // ============================================",
					"  // PART 3: Generate Request Variables",
					"  // ============================================",
					"  console.log('\\n=== Request Variables ===');",
					"  ",
					"  // Generate correlation ID if not already set",
					"  if (!col.get('correlationId')) {",
					"    const correlationId = pm.variables.replaceIn('{{$guid}}');",
					"    col.set('correlationId', correlationId);",
					"    console.log(`[VAR] ✓ Generated correlationId: ${correlationId}`);",
					"  } else {",
					"    console.log(`[VAR] ✓ Using existing correlationId: ${col.get('correlationId')}`);",
					"  }",
					"",
					"  // Generate date variables",
					"  const today = new Date();",
					"  const tomorrow = new Date(today);",
					"  tomorrow.setDate(tomorrow.getDate() + 1);",
					"",
					"  const todayStr = today.toISOString().split('T')[0];",
					"  const tomorrowStr = tomorrow.toISOString().split('T')[0];",
					"",
					"  col.set('today', todayStr);",
					"  col.set('tomorrow', tomorrowStr);",
					"  console.log(`[VAR] ✓ Generated dates - Today: ${todayStr}, Tomorrow: ${tomorrowStr}`);",
					"",
					"  // Generate unique URN reference",
					"  const uniqueRef = String(Math.floor(10000 + Math.random() * 90000));",
					"  col.set('urnUniqueRef', uniqueRef);",
					"  console.log(`[VAR] ✓ Generated urnUniqueRef: ${uniqueRef}`);",
					"",
					"  // ============================================",
					"  // SUMMARY",
					"  // ============================================",
					"  console.log('\\n=== Pre-Request Summary ===');",
					"  ",
					"  if (errors.length > 0) {",
					"    console.error(`❌ ${errors.length} error(s) occurred:`);",
					"    errors.forEach(err => console.error(`  - ${err}`));",
					"  }",
					"  ",
					"  if (warnings.length > 0) {",
					"    console.warn(`⚠ ${warnings.length} warning(s):`);",
					"    warnings.forEach(warn => console.warn(`  - ${warn}`));",
					"  }",
					"  ",
					"  if (errors.length === 0 && warnings.length === 0) {",
					"    console.log('✓ All operations completed successfully');",
					"  }",
					"",
					"})();"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"requests": {},
				"exec": [
					"// Collection-level test script",
					"// Individual test assertions are handled at the request level"
				]
			}
		}
	],
	"variable": [
		{
			"key": "baseUrl",
			"value": "http://localhost:7072"
		},
		{
			"key": "tenantId",
			"value": ""
		},
		{
			"key": "clientId",
			"value": ""
		},
		{
			"key": "clientSecret",
			"value": ""
		},
		{
			"key": "scope",
			"value": ""
		},
		{
			"key": "accessToken",
			"value": ""
		},
		{
			"key": "correlationId",
			"value": ""
		},
		{
			"key": "today",
			"value": ""
		},
		{
			"key": "tomorrow",
			"value": ""
		},
		{
			"key": "urnUniqueRef",
			"value": ""
		},
		{
			"key": "accessTokenExpiry",
			"value": ""
		},
		{
			"key": "mdsBaseUrl",
			"value": ""
		},
		{
			"key": "mdsAccessKey",
			"value": ""
		},
		{
			"key": "cmsUsername",
			"value": ""
		},
		{
			"key": "cmsPassword",
			"value": ""
		},
		{
			"key": "cmsAuth",
			"value": ""
		}
	]
}